const e=require("fs"),r=require("path"),n=require("path-exists"),t=require("../../template"),s=require("../../utils/appendDependencies"),o=require("../../logger"),c=require("../settings"),i=require("../../logger");module.exports=((a,p)=>{const l={},u=a.isCustomScaffold,d={destDir:a.targetPath,scaffold:a.scaffold,projectName:a.projectName,progressFunc:a.progressFunc,commonBlock:!0,interpreter:({type:e,message:r,data:n},t)=>{switch(o.info("generate project",e,r),e){case"FILE_CREATED":t(!0);break;default:t(!0)}}},f=c.get("isAlibaba"),b=a.scaffold&&a.scaffold.devDependencies,m=f&&b["ice-scripts"];return t.createProject(d,p).then(()=>{if(m){i.debug("\u5185\u7f51\u7528\u6237\uff0c\u521b\u5efa abc.json");const t=r.join(d.destDir,"abc.json");return new Promise(r=>{const s={name:d.projectName,type:"iceworks",builder:"@ali/builder-iceworks"};n.sync(t)?r():e.writeFile(t,JSON.stringify(s,null,2),()=>{r()})})}return Promise.resolve()}).then(()=>{if(m){i.debug("\u5185\u7f51\u7528\u6237\uff0c.webpackrc.js");const t=r.join(d.destDir,".webpackrc.js");return new Promise(r=>{n.sync(t)?r():e.writeFile(t,"let publicPathCdn = '/'; // \u9759\u6001\u8d44\u6e90\u5b58\u653e\u5730\u5740\n\nif (\n  process.env.BUILD_ENV === 'cloud' &&\n  /^([^\\/]+)\\/(\\d+\\.\\d+\\.\\d+)$/.test(process.env.BUILD_GIT_BRANCH)\n) {\n  // \u4e91\u6784\u5efa\u5206\u652f\u540d\u89c4\u5219\uff1a http://def.alibaba-inc.com/doc/publish/branch_name\n  publicPathCdn =\n    [\n      '//g.alicdn.com', // alicdn \u5730\u5740\n      process.env.BUILD_GIT_GROUP,\n      process.env.BUILD_GIT_PROJECT,\n      process.env.BUILD_GIT_BRANCH.replace(/([^\\/]+)\\//, ''),\n    ].join('/') + '/';\n}\n\nmodule.exports = {\n  output: {\n    publicPath: publicPathCdn,\n  },\n};\n          ",()=>{r()})})}return Promise.resolve()}).then(()=>(o.report("app",{action:u?"custom-generator-project":"generator-project",scaffold:a.scaffold.name,group:f?"alibaba":"outer"}),s(d.destDir,l)))});