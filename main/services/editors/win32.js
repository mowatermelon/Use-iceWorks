const e=require("path"),t=require("path-exists"),{ExternalEditor:r}=require("./shared"),o=require("../../logger"),{readRegistryKeySafe:n}=require("../../registry");function i(e){switch(e){case r.Atom:return["HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\atom"];case r.VisualStudioCode:return["HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{EA457B21-F73E-494C-ACAB-524FDE069978}_is1","HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{1287CAD5-7C8D-410D-88B9-0D1EE4A83FF2}_is1","HKEY_LOCAL_MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{F8A2A208-72B3-4D61-95FC-8A65D340689B}_is1","HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{C26E74D1-022E-4238-8B9D-1E7564A36CC9}_is1"];case r.SublimeText:return["HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Sublime Text 3_is1"];case r.WebStorm:return["HKEY_CLASSES_ROOT\\Applications\\webstorm.exe\\shell\\open\\command"];default:return new Error(`Unknown external editor: ${e}`)}}function a(t,o){switch(t){case r.Atom:return e.join(o,"bin","atom.cmd");case r.VisualStudioCode:return e.join(o,"bin","code.cmd");case r.SublimeText:return e.join(o,"subl.exe");case r.WebStorm:return e.join(o,"bin","webstorm64.exe");default:return new Error(`Unknown external editor: ${t}`)}}function s(e,t,o){switch(e){case r.Atom:return"Atom"===t&&"GitHub Inc."===o;case r.VisualStudioCode:return("Microsoft Visual Studio Code"===t||"Microsoft Visual Studio Code Insiders"===t)&&"Microsoft Corporation"===o;case r.SublimeText:return"Sublime Text"===t&&"Sublime HQ Pty Ltd"===o;case r.WebStorm:return"WebStorm"===t&&"JetBrains s.r.o."===o;default:return new Error(`Unknown external editor: ${e}`)}}function u(t,o){let n="",i="",a="";if(t===r.Atom){for(const e of o)"DisplayName"===e.name?n=e.value:"Publisher"===e.name?i=e.value:"InstallLocation"===e.name&&(a=e.value);return{displayName:n,publisher:i,installLocation:a}}if(t===r.VisualStudioCode){for(const e of o)"DisplayName"===e.name?n=e.value:"Publisher"===e.name?i=e.value:"InstallLocation"===e.name&&(a=e.value);return{displayName:n,publisher:i,installLocation:a}}if(t===r.SublimeText){for(const e of o)"DisplayName"===e.name&&e.value&&e.value.startsWith("Sublime Text")?n="Sublime Text":"Publisher"===e.name?i=e.value:"InstallLocation"===e.name&&(a=e.value);return{displayName:n,publisher:i,installLocation:a}}if(t===r.WebStorm){for(const t of o)if("(Default)"===t.name){n="WebStorm",i="JetBrains s.r.o.";const r=t.value.replace(' "%1"',"").replace(/\"/g,"");a=e.resolve(r,"../../")}return{displayName:n,publisher:i,installLocation:a}}return new Error(`Unknown external editor: ${t}`)}async function l(e){const r=i(e);let l=[];for(const e of r)if((l=await n(e)).length>0)break;if(0===l.length)return null;const{displayName:m,publisher:c,installLocation:d}=u(e,l);if(!s(e,m,c))return o.debug(`Registry entry for ${e} did not match expected publisher settings`),null;const S=a(e,d);return await t(S)?S:(o.debug(`Command line interface for ${e} not found at '${S}'`),null)}exports.parse=function(e){return e===r.Atom?r.Atom:e===r.VisualStudioCode?r.VisualStudioCode:e===r.SublimeText?r.SublimeText:e===r.WebStorm?r.WebStorm:null},exports.getAvailableEditors=async function(){const e=[],[t,o,n,i]=await Promise.all([l(r.Atom),l(r.VisualStudioCode),l(r.SublimeText),l(r.WebStorm)]);return t&&e.push({name:"Atom",editor:r.Atom,path:t}),o&&e.push({name:"VisualStudioCode",editor:r.VisualStudioCode,path:o}),n&&e.push({name:"SublimeText",editor:r.SublimeText,path:n}),i&&e.push({name:"WebStorm",editor:r.WebStorm,path:i}),e};