const e=require("fs"),r=require("mkdirp"),t=require("path"),i=require("request"),n=require("request-progress"),o=require("zlib"),s=require("tar"),a=require("../../logger");module.exports=function(p,u,c={},l=(()=>{}),q=(()=>{})){return new Promise((d,f)=>{const g=[],m=[],b=n(i({url:p}));q(b),b.on("progress",e=>{l(e)}).on("error",e=>{a.error(e),f(e)}).pipe(o.Unzip()).on("error",e=>{a.error(e),f("abort")}).pipe(s.Parse()).on("entry",i=>{if(/\.npmignore/.test(i.path))return;let n=i.path.replace(/^package\//,"");const o=c.sourceCodeDirectory||"";if(o){if(!n.startsWith(o))return;n=n.replace(o,"")}let s=t.join(u,n);const p=t.parse(s);"_gitignore"==p.base&&(p.base=p.base.replace(/^_/,".")),s=t.format(p);const l=t.dirname(s);m.includes(l)||(m.push(l),r.sync(t.dirname(s))),a.info("extractTarball",s),i.pipe(e.createWriteStream(s)),g.push(s)}).on("end",()=>{a.info("end",p),l({percent:1}),d(g)})})};