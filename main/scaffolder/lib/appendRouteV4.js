const e=require("babylon"),r=require("fs"),t=require("babel-generator").default,i=require("prettier"),o=require("babel-types"),n=require("babel-traverse").default,a=require("uppercamelcase"),s=require("../../config");function l({path:e,layout:r="",component:t}){return r?o.objectExpression([o.objectProperty(o.stringLiteral("path"),o.stringLiteral(e)),o.objectProperty(o.stringLiteral("layout"),o.identifier(a(r))),o.objectProperty(o.stringLiteral("component"),o.identifier(t))]):o.objectExpression([o.objectProperty(o.stringLiteral("path"),o.stringLiteral(e)),o.objectProperty(o.stringLiteral("component"),o.identifier(t))])}function p({name:e,source:r}){return o.importDeclaration([o.importDefaultSpecifier(o.identifier(e))],o.stringLiteral(r))}function c({program:e},r){let t=0;e.body.forEach((e,r)=>{o.isImportDeclaration(e)&&(t=r)}),e.body.splice(t,0,r)}let u=!1,m=!1;const f="routerConfig";module.exports=async function({routePath:y,routerConfigFilePath:d,pageFolderName:g,layoutName:b}){const h=r.readFileSync(d).toString(),P=e.parse(h,{sourceType:"module",plugins:["*"]});y="/"+y.replace(/^\//,""),n(P,{Program(){u=!1,m=!1},VariableDeclarator({node:e}){if(o.isIdentifier(e.id,{name:f})&&o.isArrayExpression(e.init)){let r=-1;e.init.elements.some((e,t)=>{const i=e.properties.some(e=>"path"===e.key.name&&e.value.value===y);return i&&"/IceworksPreviewPage"==y&&(r=t),i})?-1!=r&&e.init.elements.splice(r,1,l({path:y,layout:b,component:g})):e.init.elements.push(l({path:y,layout:b,component:g})),e.init.elements=e.init.elements.sort(e=>{return e.properties.some(e=>"path"===e.key.name&&"*"===e.value.value)?1:0})}},ImportDeclaration({node:e}){u||(u=e.specifiers.some(e=>!(!o.isImportDefaultSpecifier(e)||!o.isIdentifier(e.local)||e.local.name!=g))),!m&&b&&(m=e.specifiers.some(e=>!(!o.isImportDefaultSpecifier(e)||!o.isIdentifier(e.local)||e.local.name!=a(b))))}}),u||c(P,p({name:g,source:`./pages/${g}`})),!m&&b&&c(P,p({name:a(b),source:`./layouts/${b}`})),r.writeFileSync(d,i.format(t(P).code,s.prettier))};