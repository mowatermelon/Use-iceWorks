const e=require("fs"),t=require("kebab-case"),r=require("mkdirp"),a=require("path"),s=require("uppercamelcase"),n=require("util"),o=require("vm"),c=require("./utils"),i=require("./routes"),l=require("./pageTemplates"),p=require("prettier"),u=require("./interactiveFileReplacement"),d=require("./errors/DependenciesError"),m=require("../../config"),g=require("../../template/utils"),y=["*","404","502"];module.exports=async function({pageName:f,routePath:v,routeText:h,routeIcon:N,destDir:w,layout:x,blocks:j=[],interpreter:P,commonBlock:b=!1,preview:S=!1,builtIn:E=!1,libary:k="react"}){let I=[];if(S&&(f="IceworksPreviewPage",v="IceworksPreviewPage",h="IceworksPreviewPage"),!await c.checkValidICEProject(w))return c.createInterpreter("UNSUPPORTED_DESTPATH",{destDir:w},P),[];const D=s(f||"");f=t(D||"").replace(/^-/,"");const q=a.join(w,"src/pages",D);if(E&&e.existsSync(q)&&e.readdirSync(q).length>0){if(!await c.createInterpreter("DESTDIR_EXISTS_OVERRIDE",{dir:q,destDir:w},P))return[]}const R=a.join(w,"package.json"),$=JSON.parse(e.readFileSync(R));$.dependencies=$.dependencies||{};const A={};if(Array.isArray(j))for(let e=0;e<j.length;e++){const t=j[e],{dependencies:r}=await c.getDependenciesFromMaterial(t);Object.keys(r).forEach(e=>{const t=r[e];$.dependencies.hasOwnProperty(e)||(A[e]=t)})}if(Object.keys(A).length>0){if(!await c.createInterpreter("ADD_DEPENDENCIES",A,P)){const e=j.map(e=>`${e.npm}@${e.version}`).join(" "),t=Object.keys(A).map(e=>`${e}@${A[e]}`).join(" ");throw new d("blocks \u5b89\u88c5\u5931\u8d25",{message:`\u65e0\u6cd5\u5b89\u88c5\u4ee5\u4e0b\u533a\u5757\uff1a\n    blocks: ${e}\n    dependencies: ${t}`})}}if(Array.isArray(j))for(let e=0;e<j.length;e++){const t=j[e],r=await g.getTarballURLBySource(t.source),n=t.alias||t.className||t.name;let o="src/components";const i=s(t.alias||t.className||t.name);t.className=i,t.relativePath=`../../components/${n}`,S?(t.relativePath=`./blocks/${n}`,o="src/pages/IceworksPreviewPage/blocks"):(b||t.common)&&(t.relativePath=`./components/${n}`,o=`src/pages/${D}/components`);const l=await c.extractBlock(a.join(w,o,n),r,w);I=I.concat(l)}const O={layout:x.name,blocks:j,className:D,pageName:f},F=s(x.name),T=a.join(w,"src/layouts",F);if(!e.existsSync(T)){const e=await g.getTarballURLBySource(x.source);console.log(e);const t=g.getDependenciesByMaterial(x),r={};Object.keys(t).forEach(e=>{const a=t[e];$.dependencies.hasOwnProperty(e)||(r[e]=a)}),(await c.extractBlock(T,e,w)).forEach(e=>I.push(e))}r.sync(q);const _=l(k).reduce((t,r)=>{try{const s=r.compile(O),n=r.fileName.replace(/PAGE/g,D).replace(/\.ejs$/g,""),o=a.join(q,n),c=a.extname(o);let i="vue"===k?"vue":"babylon";".scss"==c&&(i="scss");const l=p.format(s,Object.assign({},m.prettier,{parser:i}));return I.push(o),e.writeFileSync(o,l,"utf-8"),1&t}catch(e){return console.log("err",e),0&t}},1);let G=a.join(w,"src/routes.jsx");e.existsSync(G)||(G=a.join(w,"src/router.js"));const C=new u({file:G,tagPrefix:"// \x3c!-- auto generated routes start --\x3e",tagSuffix:"// \x3c!-- auto generated routes end --\x3e"}),B=i._parseRoute(C.getFileContent());i.addImports(B.program.body,[{type:"page",ref:D},{type:"layout",ref:F}]),i.addRoute(B.program.body,{path:v,childRoutes:[],component:"id "+F,indexRoute:{component:"id "+D}});const{code:H}=i._generateRoute({type:"Program",body:B.program.body});C.replace(p.format(H,m.prettier));let L,U="",J=!1;const M=a.join(w,"src/config/navs.json"),V=a.join(w,"src/navs.js");let W=!1;if(e.existsSync(M)&&(U=M,J=!0,W=!0),!J&&e.existsSync(V)&&(W=!0,U=V,L=new u({file:V,tagPrefix:"// \x3c!-- auto generated navs start --\x3e",tagSuffix:"// \x3c!-- auto generated navs end --\x3e"})),W){const t=e.readFileSync(U);let r;if(J)try{r=JSON.parse(t)}catch(e){r={headerNavs:[],asideNavs:[]}}else{const e=L.getFileContent(),t={};o.createContext(t);try{o.runInContext(`${e}\nvar result = {autoGenHeaderNavs,autoGenAsideNavs};`,t)}catch(e){t.result={}}r={headerNavs:t.result.autoGenHeaderNavs||[],asideNavs:t.result.autoGenAsideNavs||[]}}if(!S&&!E){let e=v.startsWith("/")?v:`/${v}`;e=e.split("/").map(e=>e&&":"===e[0]?/id/i.test(e)?"1":e.replace(/^:/,""):e).join("/");const t=r.asideNavs.some(t=>t.to===e),a=r.headerNavs.some(t=>t.to===e),s={text:h||f,to:e,icon:N||"nav-list"};"/"!==v&&h&&!a&&(t?r.asideNavs=r.asideNavs.map(t=>t.to===e?s:t):y.indexOf(v)>-1||r.asideNavs.push(s))}J?e.writeFileSync(V,JSON.stringify(r,null,2)):L.replace(p.format(`const autoGenHeaderNavs = ${n.inspect(r.headerNavs,{showHidden:!1,depth:null})};\n    const autoGenAsideNavs = ${n.inspect(r.asideNavs,{showHidden:!1,depth:null})};`,m.prettier))}return I.push(G),_?await c.createInterpreter("FILE_CREATED",I,P):await c.createInterpreter("RENDER_PAGE_FAIL",!0,P),I};