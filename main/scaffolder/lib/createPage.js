const e=require("fs"),t=require("kebab-case"),r=require("mkdirp"),a=require("path"),n=require("uppercamelcase"),o=require("path-exists"),s=require("./utils"),c=require("./pageTemplates"),i=require("prettier"),l=require("./errors/DependenciesError"),u=require("../../config"),p=require("../../template/utils"),m=require("./appendRouteV3"),g=require("./appendRouteV4"),d=require("./appendMenuV4"),y=require("../../logger");module.exports=async function({pageName:f,routePath:h,routeText:w,routeIcon:P,destDir:j,layout:b,blocks:E=[],interpreter:k,commonBlock:D=!1,preview:I=!1,builtIn:N=!1,libary:S="react",excludeLayout:q=!1}){let C=[];h=h||f;const $=a.join(j,"package.json");let O={};if(o.sync($))try{const t=e.readFileSync($);O=JSON.parse(t.toString())}catch(e){}if(I&&(f="IceworksPreviewPage",h="IceworksPreviewPage",w="IceworksPreviewPage"),!await s.checkValidICEProject(j))return s.createInterpreter("UNSUPPORTED_DESTPATH",{destDir:j},k),[];const v=n(f||"");f=t(v).replace(/^-/,"");const x=a.join(j,"src/pages",v);if(N&&e.existsSync(x)&&e.readdirSync(x).length>0){if(!await s.createInterpreter("DESTDIR_EXISTS_OVERRIDE",{dir:x,destDir:j},k))return[]}const F=a.join(j,"package.json"),A=JSON.parse(e.readFileSync(F));A.dependencies=A.dependencies||{};const R={};if(Array.isArray(E))for(let e=0;e<E.length;e++){const t=E[e],r=await p.getDependenciesByMaterial(t);Object.keys(r).forEach(e=>{const t=r[e];A.dependencies.hasOwnProperty(e)||(R[e]=t)})}const T={};let _="";if(b){_=b.name;const t=a.join(j,"src/layouts",b.name),r=e.existsSync(t);if(!q&&!b.localization&&!r){const e=await p.getTarballURLBySource(b.source),r=p.getDependenciesByMaterial(b);Object.keys(r).forEach(e=>{const t=r[e];A.dependencies.hasOwnProperty(e)||(T[e]=t)}),(await s.extractBlock(t,e,j)).forEach(e=>C.push(e))}}if(Object.keys(R).length>0){if(!await s.createInterpreter("ADD_DEPENDENCIES",R,k)){const e=E.map(({source:e})=>`${e.npm}@${e.version}`).join(" "),t=Object.keys(R).map(e=>`${e}@${R[e]}`).join(" ");throw new l("blocks \u5b89\u88c5\u5931\u8d25",{message:`\u65e0\u6cd5\u5b89\u88c5\u4ee5\u4e0b\u533a\u5757\uff1a blocks: ${e} dependencies: ${t}`})}}if(Object.keys(T).length>0){if(!await s.createInterpreter("ADD_DEPENDENCIES",T,k)){const e=Object.keys(T).map(e=>`${e}@${T[e]}`).join(" ");throw new l("layout \u5b89\u88c5\u5931\u8d25",{message:`\u65e0\u6cd5\u5b89\u88c5\u4ee5\u4e0b\u533a\u5757\uff1a layout: ${_} dependencies: ${e}`})}}if(Array.isArray(E))for(let e=0;e<E.length;e++){const t=E[e];y.report("app",{action:"download-block",data:{name:t.name}});const r=await p.getTarballURLBySource(t.source),o=t.alias||t.className||t.name;let c="src/components";const i=n(t.alias||t.className||t.name);t.className=i,t.relativePath=`../../components/${o}`,I?(t.relativePath=`./blocks/${o}`,c="src/pages/IceworksPreviewPage/blocks"):(D||t.common)&&(t.relativePath=`./components/${o}`,c=`src/pages/${v}/components`);const l=await s.extractBlock(a.join(j,c,o),r,j);C=C.concat(l)}const B=O.scaffoldConfig||{},L={layout:b&&b.name||"",blocks:E,className:v,pageName:f,scaffoldConfig:B};r.sync(x);const V=c(S).reduce((t,r)=>{try{const n=r.compile(L),o=r.fileName.replace(/PAGE/g,v).replace(/\.ejs$/g,""),s=a.join(x,o),c=a.extname(s);let l="vue"===S?"vue":"babylon";".scss"==c&&(l="scss");const p=i.format(n,Object.assign({},u.prettier,{parser:l}));return C.push(s),e.writeFileSync(s,p,"utf-8"),1&t}catch(e){return console.log("err",e),0&t}},1);let U=a.join(j,"src/routes.jsx"),M=a.join(j,"src/routerConfig.js"),G=a.join(j,"src/menuConfig.js");return e.existsSync(U)||(U=a.join(j,"src/router.js")),o.sync(G)&&w&&(y.debug("\u5199\u5165 menuConfig",{name:w,path:h,menuConfigFilePath:G}),await d({name:w,path:h,menuConfigFilePath:G}).catch(y.debug)),o.sync(M)?(y.debug("\u5199\u5165 routerConfig",{name:w,path:h,menuConfigFilePath:G}),await g({routePath:h,routerConfigFilePath:M,pageFolderName:v,layoutName:_}).catch(y.debug)):await m({destDir:j,routePath:h,routeText:w,routeIcon:P,pageName:f,routeFilePath:U,pageFolderName:v,layoutClassName:n(_),preview:I,builtIn:N}).catch(()=>{}),C.push(U),V?await s.createInterpreter("FILE_CREATED",C,k):await s.createInterpreter("RENDER_PAGE_FAIL",!0,k),C};