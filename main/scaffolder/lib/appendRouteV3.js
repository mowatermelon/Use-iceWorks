const e=require("fs"),t=require("path"),a=require("path-exists"),r=require("prettier"),s=require("util"),o=require("vm"),n=require("./interactiveFileReplacement"),i=require("./routes"),d=require("../../config"),u=["*","404","502"];module.exports=async function({destDir:c,routePath:l,routeText:p,routeIcon:v,pageName:f,routeFilePath:x,pageFolderName:N,layoutClassName:g,preview:m,builtIn:h}){if(a.sync(x)){const e=new n({file:x,tagPrefix:"// \x3c!-- auto generated routes start --\x3e",tagSuffix:"// \x3c!-- auto generated routes end --\x3e"}),t=i._parseRoute(e.getFileContent());i.addImports(t.program.body,[{type:"page",ref:N},{type:"layout",ref:g}]),i.addRoute(t.program.body,{path:l,childRoutes:[],component:"id "+g,indexRoute:{component:"id "+N}});const{code:a}=i._generateRoute({type:"Program",body:t.program.body});e.replace(r.format(a,d.prettier))}let y,q="",S=!1;const F=t.join(c,"src/config/navs.json"),w=t.join(c,"src/navs.js");let G=!1;if(e.existsSync(F)&&(q=F,S=!0,G=!0),!S&&e.existsSync(w)&&(G=!0,q=w,y=new n({file:w,tagPrefix:"// \x3c!-- auto generated navs start --\x3e",tagSuffix:"// \x3c!-- auto generated navs end --\x3e"})),G){const t=e.readFileSync(q);let a;if(S)try{a=JSON.parse(t)}catch(e){a={headerNavs:[],asideNavs:[]}}else{const e=y.getFileContent(),t={};o.createContext(t);try{o.runInContext(`${e}\nvar result = {autoGenHeaderNavs,autoGenAsideNavs};`,t)}catch(e){t.result={}}a={headerNavs:t.result.autoGenHeaderNavs||[],asideNavs:t.result.autoGenAsideNavs||[]}}if(!m&&!h){let e=l.startsWith("/")?l:`/${l}`;e=e.split("/").map(e=>e&&":"===e[0]?/id/i.test(e)?"1":e.replace(/^:/,""):e).join("/");const t=a.asideNavs.some(t=>t.to===e),r=a.headerNavs.some(t=>t.to===e),s={text:p||f,to:e,icon:v||"nav-list"};"/"!==l&&p&&!r&&(t?a.asideNavs=a.asideNavs.map(t=>t.to===e?s:t):u.indexOf(l)>-1||a.asideNavs.push(s))}S?e.writeFileSync(w,JSON.stringify(a,null,2)):y.replace(r.format(`const autoGenHeaderNavs = ${s.inspect(a.headerNavs,{showHidden:!1,depth:null})};\n          const autoGenAsideNavs = ${s.inspect(a.asideNavs,{showHidden:!1,depth:null})};`,d.prettier))}};