const e=require("debug")("utils"),r=require("fs"),n=require("mkdirp"),t=require("path"),o=require("request"),s=require("tar"),i=require("uppercamelcase"),c=require("zlib"),a=require("../../config"),p=require("./errors/DependenciesError"),u=require("../../template/utils"),d=require("../../utils/npmRequest"),l=require("../../logger");function m({destDir:e=process.cwd(),blocks:r,pageName:n}){return Promise.all(r.map(r=>g({destDir:e,pageName:n,block:r}))).then(e=>Promise.all(e.map((e,n)=>{const t=r[n];return t.npm&&t.version?y({npm:t.npm,version:t.version}):t.source&&"npm"==t.source.type?y({npm:t.source.npm,version:t.source.version,registry:t.source.registry}):void 0}))).then(e=>{const r={},n={},t={};return e.forEach(({dependencies:e,devDependencies:o,peerDependencies:s})=>{Object.assign(r,e),Object.assign(n,o),Object.assign(t,s)}),{dependencies:r,devDependencies:n,peerDependencies:t}})}function g({destDir:e=process.cwd(),block:r,pageName:o}){if(!r||!r.source)throw new Error("block need to have specified source at download block to page method.");const s=t.join(e,"src/pages",o,"components");return n.sync(s),l.report("app",{action:"download-block",data:{name:r.name}}),u.getTarballURLBySource(r.source).then(n=>h(t.join(s,r.alias||i(r.name)||r.className),n,e))}function f(i,a){return new Promise((p,u)=>{e("npmTarball",i);const d=[];o.get(i).on("error",u).pipe(c.Unzip()).pipe(s.Parse()).on("entry",o=>{if(/\.npmignore/.test(o.path))return;const s=o.path.replace(/^package\//,"");e("\u5199\u5165\u6587\u4ef6",s);let i=t.join(a,s);const c=t.parse(i);"_gitignore"==c.base&&(c.base=c.base.replace(/^_/,".")),i=t.format(c),n.sync(t.dirname(i)),o.pipe(r.createWriteStream(i)),d.push(i)}).on("end",()=>{p(d)})})}function h(i,a,p,u){return new Promise((d,l)=>{e("npmTarball",a);const m=[];o.get(a).on("error",l).pipe(c.Unzip()).pipe(s.Parse()).on("entry",o=>{if(!/src|mock\//.test(o.path))return;if(Array.isArray(u)&&u.some(e=>new RegExp(e).test(o.path)))return;let s="";if(-1!==o.path.indexOf("mock/"))s=t.join(p,o.path.replace(/^package\//,""));else{const e=o.path.replace(/^package\//,"").replace(/src/g,"");s=t.join(i,e)}e("\u5199\u5165\u6587\u4ef6",s),r.existsSync(s)||(n.sync(t.dirname(s)),o.pipe(r.createWriteStream(s)),m.push(s))}).on("end",()=>{d(m)})})}function b(e,r="latest"){return new Promise((n,t)=>{d({name:e,version:r}).then(e=>{n(e.dist.tarball)}).catch(t)})}function y({npm:e,version:r="latest",registry:n}){return new Promise((t,o)=>{d({name:e,version:r,registry:n}).then(e=>{t({dependencies:e.dependencies,devDependencies:e.devDependencies,peerDependencies:e.peerDependencies})}).catch(n=>{o(new p(`${e}@${r} not found`,{body:n,message:`${e}@${r} \u4e0d\u5b58\u5728`}))})})}const k="cn";async function q(e={}){return{dependencies:e.components||{}}}exports.createInterpreter=function(e,r={},n){const t=(a.locale[e]||a.locale.unknown).cn;return new Promise(o=>{n({type:e,message:t,data:r},e=>{o(e)})})},exports.checkValidICEProject=function(e){if(!r.existsSync(e))return!1;const n=t.join(e,"package.json");try{const e=require(n);return"scaffoldConfig"in e||"buildConfig"in e}catch(e){}try{const r=t.join(e,"abc.json"),n=require(r);return"project"===n.repository.type&&"ice"===n.type}catch(e){return!1}},exports.getTarballURL=b,exports.extractBlock=h,exports.getDependenciesFromNpm=y,exports.getDependenciesFromMaterial=q,exports.extractTarball=f,exports.downloadBlockToPage=g,exports.downloadBlocksToPage=m;