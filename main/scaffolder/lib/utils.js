const e=require("debug")("utils"),r=require("fs"),n=require("mkdirp"),t=require("path"),s=require("request"),o=require("tar"),i=require("zlib"),c=require("../../config"),a=require("./errors/DependenciesError");function p({destDir:e=process.cwd(),blocks:r,pageName:n}){return Promise.all(r.map(r=>d({destDir:e,pageName:n,block:r}))).then(e=>Promise.all(e.map((e,n)=>{const t=r[n];return g(t.npm,t.version)}))).then(e=>{const r={},n={},t={};return e.forEach(({dependencies:e,devDependencies:s,peerDependencies:o})=>{Object.assign(r,e),Object.assign(n,s),Object.assign(t,o)}),{dependencies:r,devDependencies:n,peerDependencies:t}})}function d({destDir:e=process.cwd(),block:r,pageName:s}){if(!r||!r.npm||!r.className)throw new Error("block need to have npm and className at download block to page method.");const o=t.join(e,"src/pages",s,"components");return n.sync(o),m(r.npm,r.version||"latest").then(n=>u(t.join(o,r.alias||r.className),n,e))}function l(c,a){return new Promise((p,d)=>{e("npmTarball",c);const l=[];s.get(c).on("error",d).pipe(i.Unzip()).pipe(o.Parse()).on("entry",s=>{if(/\.npmignore/.test(s.path))return;const o=s.path.replace(/^package\//,"");e("\u5199\u5165\u6587\u4ef6",o);const i=t.join(a,o);n.sync(t.dirname(i)),s.pipe(r.createWriteStream(i)),l.push(i)}).on("end",()=>{p(l)})})}function u(c,a,p,d){return new Promise((l,u)=>{e("npmTarball",a);const m=[],g=[];s.get(a).on("error",u).pipe(i.Unzip()).pipe(o.Parse()).on("entry",s=>{if(!/src|mock\//.test(s.path))return;if(Array.isArray(d)&&d.some(e=>new RegExp(e).test(s.path)))return;let o="";if(-1!==s.path.indexOf("mock/"))o=t.join(p,s.path.replace(/^package\//,""));else{const e=s.path.replace(/^package\//,"").replace(/src/g,"");o=t.join(c,e);const r=t.basename(e),n=/^__([^_]+)_([^_]+)__/.exec(r);if(n&&n[1]&&n[2]){const e=t.extname(r);o=t.join(p,"src",n[1],n[2]+e),g.push({destPath:o,projectDir:p,dir:n[1],file:n[2],extName:e})}else{const e=/^__([^_]+)__/.exec(r);if(e&&e[1]){const n=t.extname(r);o=t.join(p,"src",e[1]+n),g.push({destPath:o,projectDir:p,dir:".",file:e[1],extName:n})}else g.push({destPath:o,projectDir:p})}}e("\u5199\u5165\u6587\u4ef6",o),r.existsSync(o)||(n.sync(t.dirname(o)),s.pipe(r.createWriteStream(o)),m.push(o))}).on("end",()=>{g.forEach(({destPath:e,projectDir:n,dir:s})=>{setTimeout(()=>{const o=r.readFileSync(e,"utf-8"),i=t.relative(n,e),c=o.replace(new RegExp(`__${s}_([^_]+)__`,"g"),(e,r)=>r).replace(new RegExp("__([^_]+)_([^_]+)__","g"),(e,r,n)=>/components/.test(i)&&"config"===r?`../${r}/${n}`:r!==s?`../../${r}/${n}`:e).replace(new RegExp("__([^_]+)__","g"),(e,r)=>/components/.test(i)?`../${r}`:`../../${r}`),a=t.parse(e);a.base=a.base.replace(/^_/,""),r.writeFileSync(t.format(a),c,"utf-8")},500)}),l(m)})})}function m(e,r="latest"){return new Promise((n,t)=>{s({url:`${c.registry}/${e}/${r}`,json:!0},(e,r,s)=>{!e&&s&&s.dist&&s.dist.tarball?n(s.dist.tarball):t(e||new Error(JSON.stringify(r.body)))})})}function g(e,r="latest"){return new Promise((n,t)=>{s({url:`${c.registry}/${e}/${r}`,json:!0},(s,o,i)=>{!s&&i&&i.dist&&i.dist.tarball?n({dependencies:i.dependencies,devDependencies:i.devDependencies,peerDependencies:i.peerDependencies}):t(new a(`${e} not found`,{body:o.body,message:`${e}@${r} \u4e0d\u5b58\u5728`}))})})}const _="cn";exports.createInterpreter=function(e,r={},n){const t=(c.locale[e]||c.locale.unknown).cn;return new Promise(s=>{n({type:e,message:t,data:r},e=>{s(e)})})},exports.checkValidICEProject=function(e){if(!r.existsSync(e))return!1;const n=t.join(e,"package.json");try{const e=require(n);return"ice"in e||"buildConfig"in e}catch(e){}try{const r=t.join(e,"abc.json"),n=require(r);return"project"===n.repository.type&&"ice"===n.type}catch(e){return!1}},exports.getTarballURL=m,exports.extractBlock=u,exports.getDependencies=g,exports.extractTarball=l,exports.downloadBlockToPage=d,exports.downloadBlocksToPage=p;