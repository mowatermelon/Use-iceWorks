const e=require("debug")("utils"),r=require("fs"),n=require("mkdirp"),t=require("path"),s=require("request"),o=require("tar"),c=require("zlib"),i=require("uppercamelcase"),a=require("../../config"),p=require("./errors/DependenciesError"),l=require("../../template/utils");function d({destDir:e=process.cwd(),blocks:r,pageName:n}){return Promise.all(r.map(r=>u({destDir:e,pageName:n,block:r}))).then(e=>Promise.all(e.map((e,n)=>{const t=r[n];return _(t.npm,t.version)}))).then(e=>{const r={},n={},t={};return e.forEach(({dependencies:e,devDependencies:s,peerDependencies:o})=>{Object.assign(r,e),Object.assign(n,s),Object.assign(t,o)}),{dependencies:r,devDependencies:n,peerDependencies:t}})}function u({destDir:e=process.cwd(),block:r,pageName:s}){if(!r||!r.source)throw new Error("block need to have specified source at download block to page method.");const o=t.join(e,"src/pages",s,"components");return n.sync(o),l.getTarballURLBySource(r.source).then(n=>g(t.join(o,r.alias||i(r.name)||r.className),n,e))}function m(i,a){return new Promise((p,l)=>{e("npmTarball",i);const d=[];s.get(i).on("error",l).pipe(c.Unzip()).pipe(o.Parse()).on("entry",s=>{if(/\.npmignore/.test(s.path))return;const o=s.path.replace(/^package\//,"");e("\u5199\u5165\u6587\u4ef6",o);let c=t.join(a,o);const i=t.parse(c);i.base=i.base.replace(/^_/,"."),i.name=i.base,c=t.format(i),n.sync(t.dirname(c)),s.pipe(r.createWriteStream(c)),d.push(c)}).on("end",()=>{p(d)})})}function g(i,a,p,l){return new Promise((d,u)=>{e("npmTarball",a);const m=[],g=[];s.get(a).on("error",u).pipe(c.Unzip()).pipe(o.Parse()).on("entry",s=>{if(!/src|mock\//.test(s.path))return;if(Array.isArray(l)&&l.some(e=>new RegExp(e).test(s.path)))return;let o="";if(-1!==s.path.indexOf("mock/"))o=t.join(p,s.path.replace(/^package\//,""));else{const e=s.path.replace(/^package\//,"").replace(/src/g,"");o=t.join(i,e);const r=t.basename(e),n=/^__([^_]+)_([^_]+)__/.exec(r);if(n&&n[1]&&n[2]){const e=t.extname(r);o=t.join(p,"src",n[1],n[2]+e),g.push({destPath:o,projectDir:p,dir:n[1],file:n[2],extName:e})}else{const e=/^__([^_]+)__/.exec(r);if(e&&e[1]){const n=t.extname(r);o=t.join(p,"src",e[1]+n),g.push({destPath:o,projectDir:p,dir:".",file:e[1],extName:n})}else g.push({destPath:o,projectDir:p})}}e("\u5199\u5165\u6587\u4ef6",o),r.existsSync(o)||(n.sync(t.dirname(o)),s.pipe(r.createWriteStream(o)),m.push(o))}).on("end",()=>{g.forEach(({destPath:e,projectDir:n,dir:s})=>{setTimeout(()=>{const o=r.readFileSync(e,"utf-8"),c=t.relative(n,e),i=o.replace(new RegExp(`__${s}_([^_]+)__`,"g"),(e,r)=>r).replace(new RegExp("__([^_]+)_([^_]+)__","g"),(e,r,n)=>/components/.test(c)&&"config"===r?`../${r}/${n}`:r!==s?`../../${r}/${n}`:e).replace(new RegExp("__([^_]+)__","g"),(e,r)=>/components/.test(c)?`../${r}`:`../../${r}`);r.writeFileSync(e,i,"utf-8")},500)}),d(m)})})}function f(e,r="latest"){return new Promise((n,t)=>{s({url:`${a.registry}/${e}/${r}`,json:!0},(e,r,s)=>{!e&&s&&s.dist&&s.dist.tarball?n(s.dist.tarball):t(e||new Error(JSON.stringify(r.body)))})})}function _(e,r="latest"){return new Promise((n,t)=>{s({url:`${a.registry}/${e}/${r}`,json:!0},(s,o,c)=>{!s&&c&&c.dist&&c.dist.tarball?n({dependencies:c.dependencies,devDependencies:c.devDependencies,peerDependencies:c.peerDependencies}):t(new p(`${e} not found`,{body:o.body,message:`${e}@${r} \u4e0d\u5b58\u5728`}))})})}const h="cn";async function b(e={}){return{dependencies:e.components||{}}}exports.createInterpreter=function(e,r={},n){const t=(a.locale[e]||a.locale.unknown).cn;return new Promise(s=>{n({type:e,message:t,data:r},e=>{s(e)})})},exports.checkValidICEProject=function(e){if(!r.existsSync(e))return!1;const n=t.join(e,"package.json");try{const e=require(n);return"ice"in e||"buildConfig"in e}catch(e){}try{const r=t.join(e,"abc.json"),n=require(r);return"project"===n.repository.type&&"ice"===n.type}catch(e){return!1}},exports.getTarballURL=f,exports.extractBlock=g,exports.getDependenciesFromNpm=_,exports.getDependenciesFromMaterial=b,exports.extractTarball=m,exports.downloadBlockToPage=u,exports.downloadBlocksToPage=d;